<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.48">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/PolarDB-for-PostgreSQL/favicon.ico"><title>LogIndex | PolarDB for PostgreSQL</title><meta name="description" content="阿里云自主研发的云原生数据库产品">
    <link rel="modulepreload" href="/PolarDB-for-PostgreSQL/assets/app.9228397b.js"><link rel="modulepreload" href="/PolarDB-for-PostgreSQL/assets/logindex.html.5f1b9a20.js"><link rel="modulepreload" href="/PolarDB-for-PostgreSQL/assets/logindex.html.92c8ae1a.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.db69ef4f.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.0301697a.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/buffer-management.html.47975b93.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/ddl-synchronization.html.3b8a1266.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/logindex.html.9a8cd7c2.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/code-of-conduct.html.a7a8e6e6.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/coding-style.html.9e53a436.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-docs.html.72118595.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-kernel.html.14782f17.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/customize-dev-env.html.29f0b38d.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-localfs.html.a4e65eca.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-pfs.html.c2eb34b4.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy-more.html.23ffeefb.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy.html.d8890f08.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/fs-pfs.html.607aa13d.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/introduction.html.da125601.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/quick-start.html.ef836136.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-aliyun-essd.html.079f4bcb.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-ceph.html.639cb75e.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-nbd.html.97a6748f.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/tpch-on-px.html.de73af08.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.45a5c105.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.31b2c184.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.1db4199f.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/buffer-management.html.66aae055.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/ddl-synchronization.html.f6764097.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/code-of-conduct.html.a542926b.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/coding-style.html.66db37ce.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-docs.html.fa69e2e1.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-kernel.html.b3ee1915.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/customize-dev-env.html.fb2f61a2.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-localfs.html.5c431922.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-pfs.html.4b059ea5.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy-more.html.325d5e8c.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy.html.5287d6a7.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/fs-pfs.html.17e4333a.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/introduction.html.7de48efb.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/quick-start.html.b3ae278e.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-aliyun-essd.html.33dc885a.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-ceph.html.48bcbaf7.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-nbd.html.83e598e1.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/tpch-on-px.html.e355841c.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.189b0b4b.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/404.html.7d858b3d.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.ba76a55f.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.2381a62e.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/buffer-management.html.50807157.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/ddl-synchronization.html.e7a4c2b5.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/logindex.html.e6559dd6.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/code-of-conduct.html.d6fdd2a2.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/coding-style.html.9b55fe59.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-docs.html.5e880347.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-kernel.html.562bc9ce.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/customize-dev-env.html.fe99cda4.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-localfs.html.a76ca858.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-pfs.html.dc210bd8.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy-more.html.5650cd4f.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy.html.12dcd068.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/fs-pfs.html.efe51d7d.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/introduction.html.f471ce68.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/quick-start.html.2562e6b5.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-aliyun-essd.html.b118389f.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-ceph.html.06141c37.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-nbd.html.c55089ce.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/tpch-on-px.html.05d2ce4f.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.a804b576.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.d4141d86.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.81e37642.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/buffer-management.html.a3771a04.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/ddl-synchronization.html.11cee4e9.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/code-of-conduct.html.75709c31.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/coding-style.html.3ab0ec49.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-docs.html.e71112e2.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/contributing-polardb-kernel.html.9a60e154.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/customize-dev-env.html.e05ce2a5.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-localfs.html.29e0c61f.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/db-pfs.html.8f480d93.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy-more.html.c9979866.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/deploy.html.8644264d.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/fs-pfs.html.bb18e787.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/introduction.html.cca53ae3.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/quick-start.html.4a3ae204.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-aliyun-essd.html.b9177d1b.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-ceph.html.fdef2c16.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/storage-nbd.html.f25ee6fa.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/tpch-on-px.html.4bfe5148.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/index.html.4e7dd1b2.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/404.html.c562a675.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/404.47ed5fa6.js"><link rel="prefetch" href="/PolarDB-for-PostgreSQL/assets/Layout.a21b7601.js">
    <link rel="stylesheet" href="/PolarDB-for-PostgreSQL/assets/style.66c1f8f6.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/PolarDB-for-PostgreSQL/zh/" class=""><img class="logo" src="/PolarDB-for-PostgreSQL/images/polardb.png" alt="PolarDB for PostgreSQL"><span class="site-name can-hide">PolarDB for PostgreSQL</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="入门指南"><span class="title">入门指南</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="入门指南"><span class="title">入门指南</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/quick-start.html" class="" aria-label="快速上手"><!--[--><!--]--> 快速上手 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/introduction.html" class="" aria-label="PolarDB 架构简介"><!--[--><!--]--> PolarDB 架构简介 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/deploy.html" class="" aria-label="进阶部署"><!--[--><!--]--> 进阶部署 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>准备块存储设备</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-ceph.html" class="" aria-label="Ceph 共享存储"><!--[--><!--]--> Ceph 共享存储 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-aliyun-essd.html" class="" aria-label="阿里云 ECS + ESSD 云盘存储"><!--[--><!--]--> 阿里云 ECS + ESSD 云盘存储 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-nbd.html" class="" aria-label="NBD 共享存储"><!--[--><!--]--> NBD 共享存储 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>准备文件系统</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/fs-pfs.html" class="" aria-label="格式化并挂载 PFS"><!--[--><!--]--> 格式化并挂载 PFS <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>编译部署 PolarDB 内核</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/db-localfs.html" class="" aria-label="PolarDB 编译部署：单机文件系统"><!--[--><!--]--> PolarDB 编译部署：单机文件系统 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/db-pfs.html" class="" aria-label="PolarDB 编译部署：PFS 文件系统"><!--[--><!--]--> PolarDB 编译部署：PFS 文件系统 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>更多</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/customize-dev-env.html" class="" aria-label="定制开发环境"><!--[--><!--]--> 定制开发环境 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/deploy-more.html" class="" aria-label="更多部署方式"><!--[--><!--]--> 更多部署方式 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>特性体验</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/tpch-on-px.html" class="" aria-label="利用 PolarDB HTAP 加速 TPC-H"><!--[--><!--]--> 利用 PolarDB HTAP 加速 TPC-H <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="架构解读"><span class="title">架构解读</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="架构解读"><span class="title">架构解读</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/" class="router-link-active" aria-label="架构详解"><!--[--><!--]--> 架构详解 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/buffer-management.html" class="" aria-label="缓冲区管理"><!--[--><!--]--> 缓冲区管理 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/ddl-synchronization.html" class="" aria-label="DDL 同步"><!--[--><!--]--> DDL 同步 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html" class="router-link-active router-link-exact-active router-link-active" aria-label="LogIndex"><!--[--><!--]--> LogIndex <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/PolarDB-for-PostgreSQL/zh/roadmap/" class="" aria-label="版本规划"><!--[--><!--]--> 版本规划 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="参与社区"><span class="title">参与社区</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="参与社区"><span class="title">参与社区</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/contributing-polardb-kernel.html" class="" aria-label="贡献代码"><!--[--><!--]--> 贡献代码 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/contributing-polardb-docs.html" class="" aria-label="贡献文档"><!--[--><!--]--> 贡献文档 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/coding-style.html" class="" aria-label="编码风格"><!--[--><!--]--> 编码风格 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/code-of-conduct.html" class="" aria-label="行为准则"><!--[--><!--]--> 行为准则 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/architecture/logindex.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/ApsaraDB/PolarDB-for-PostgreSQL" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="入门指南"><span class="title">入门指南</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="入门指南"><span class="title">入门指南</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/quick-start.html" class="" aria-label="快速上手"><!--[--><!--]--> 快速上手 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/introduction.html" class="" aria-label="PolarDB 架构简介"><!--[--><!--]--> PolarDB 架构简介 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/guide/deploy.html" class="" aria-label="进阶部署"><!--[--><!--]--> 进阶部署 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>准备块存储设备</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-ceph.html" class="" aria-label="Ceph 共享存储"><!--[--><!--]--> Ceph 共享存储 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-aliyun-essd.html" class="" aria-label="阿里云 ECS + ESSD 云盘存储"><!--[--><!--]--> 阿里云 ECS + ESSD 云盘存储 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/storage-nbd.html" class="" aria-label="NBD 共享存储"><!--[--><!--]--> NBD 共享存储 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>准备文件系统</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/fs-pfs.html" class="" aria-label="格式化并挂载 PFS"><!--[--><!--]--> 格式化并挂载 PFS <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>编译部署 PolarDB 内核</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/db-localfs.html" class="" aria-label="PolarDB 编译部署：单机文件系统"><!--[--><!--]--> PolarDB 编译部署：单机文件系统 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/db-pfs.html" class="" aria-label="PolarDB 编译部署：PFS 文件系统"><!--[--><!--]--> PolarDB 编译部署：PFS 文件系统 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>更多</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/customize-dev-env.html" class="" aria-label="定制开发环境"><!--[--><!--]--> 定制开发环境 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/deploy-more.html" class="" aria-label="更多部署方式"><!--[--><!--]--> 更多部署方式 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>特性体验</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/PolarDB-for-PostgreSQL/zh/guide/tpch-on-px.html" class="" aria-label="利用 PolarDB HTAP 加速 TPC-H"><!--[--><!--]--> 利用 PolarDB HTAP 加速 TPC-H <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="架构解读"><span class="title">架构解读</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="架构解读"><span class="title">架构解读</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/" class="router-link-active" aria-label="架构详解"><!--[--><!--]--> 架构详解 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/buffer-management.html" class="" aria-label="缓冲区管理"><!--[--><!--]--> 缓冲区管理 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/architecture/ddl-synchronization.html" class="" aria-label="DDL 同步"><!--[--><!--]--> DDL 同步 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html" class="router-link-active router-link-exact-active router-link-active" aria-label="LogIndex"><!--[--><!--]--> LogIndex <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/PolarDB-for-PostgreSQL/zh/roadmap/" class="" aria-label="版本规划"><!--[--><!--]--> 版本规划 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="参与社区"><span class="title">参与社区</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="参与社区"><span class="title">参与社区</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/contributing-polardb-kernel.html" class="" aria-label="贡献代码"><!--[--><!--]--> 贡献代码 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/contributing-polardb-docs.html" class="" aria-label="贡献文档"><!--[--><!--]--> 贡献文档 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/coding-style.html" class="" aria-label="编码风格"><!--[--><!--]--> 编码风格 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/zh/contributing/code-of-conduct.html" class="" aria-label="行为准则"><!--[--><!--]--> 行为准则 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/PolarDB-for-PostgreSQL/architecture/logindex.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/ApsaraDB/PolarDB-for-PostgreSQL" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active">架构解读 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/PolarDB-for-PostgreSQL/zh/architecture/" class="router-link-active sidebar-item" aria-label="架构详解"><!--[--><!--]--> 架构详解 <!--[--><!--]--></a><!----></li><li><a href="/PolarDB-for-PostgreSQL/zh/architecture/buffer-management.html" class="sidebar-item" aria-label="缓冲区管理"><!--[--><!--]--> 缓冲区管理 <!--[--><!--]--></a><!----></li><li><a href="/PolarDB-for-PostgreSQL/zh/architecture/ddl-synchronization.html" class="sidebar-item" aria-label="DDL 同步"><!--[--><!--]--> DDL 同步 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="LogIndex"><!--[--><!--]--> LogIndex <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html#背景介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="背景介绍"><!--[--><!--]--> 背景介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html#ro-内存同步架构" class="router-link-active router-link-exact-active sidebar-item" aria-label="RO 内存同步架构"><!--[--><!--]--> RO 内存同步架构 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html#wal-meta" class="router-link-active router-link-exact-active sidebar-item" aria-label="WAL Meta"><!--[--><!--]--> WAL Meta <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html#logindex-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="LogIndex"><!--[--><!--]--> LogIndex <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html#内存数据结构" class="router-link-active router-link-exact-active sidebar-item" aria-label="内存数据结构"><!--[--><!--]--> 内存数据结构 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html#磁盘数据结构" class="router-link-active router-link-exact-active sidebar-item" aria-label="磁盘数据结构"><!--[--><!--]--> 磁盘数据结构 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html#日志回放" class="router-link-active router-link-exact-active sidebar-item" aria-label="日志回放"><!--[--><!--]--> 日志回放 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html#延迟回放" class="router-link-active router-link-exact-active sidebar-item" aria-label="延迟回放"><!--[--><!--]--> 延迟回放 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html#mini-transaction" class="router-link-active router-link-exact-active sidebar-item" aria-label="Mini Transaction"><!--[--><!--]--> Mini Transaction <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/PolarDB-for-PostgreSQL/zh/architecture/logindex.html#总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="logindex" tabindex="-1"><a class="header-anchor" href="#logindex" aria-hidden="true">#</a> LogIndex</h1><h2 id="背景介绍" tabindex="-1"><a class="header-anchor" href="#背景介绍" aria-hidden="true">#</a> 背景介绍</h2><p>PolarDB 采用了共享存储一写多读架构，读写节点 RW 和多个只读节点 RO 共享同一份存储，读写节点可以读写共享存储中的数据；只读节点仅能各自通过回放日志，从共享存储中读取数据，而不能写入，只读节点 RO 通过内存同步来维护数据的一致性。此外，只读节点可同时对外提供服务用于实现读写分离与负载均衡，在读写节点异常 crash 时，可将只读节点提升为读写节点，保证集群的高可用。基本架构图如下所示：</p><p><img src="/PolarDB-for-PostgreSQL/assets/49_LogIndex_1.e49fa6a7.png" alt="image.png"></p><p>传统 share nothing 的架构下，只读节点 RO 有自己的内存及存储，只需要接收 RW 节点的 WAL 日志进行回放即可。如下图所示，如果需要回放的数据页不在 Buffer Pool 中，需将其从存储文件中读至 Buffer Pool 中进行回放，从而带来 CacheMiss 的成本，且持续性的回放会带来较频繁的 Buffer Pool 淘汰问题。</p><p><img src="/PolarDB-for-PostgreSQL/assets/50_LogIndex_2.2d85ed00.png" alt="image.png"></p><p>此外，RW 节点多个事务之间可并行执行，RO 节点则需依照 WAL 日志的顺序依次进行串行回放，导致 RO 回放速度较慢，与 RW 节点的延迟逐步增大。</p><p><img src="/PolarDB-for-PostgreSQL/assets/51_LogIndex_3.1c28dec4.png" alt="image.png"></p><p>与传统 share nothing 架构不同，共享存储一写多读架构下 RO 节点可直接从共享存储上获取需要回放的 WAL 日志。若共享存储上的数据页是最新的，那么 RO 可直接读取数据页而不需要再进行回放操作。基于此，PolarDB 设计了 LogIndex 来加速 RO 节点的日志回放。</p><h2 id="ro-内存同步架构" tabindex="-1"><a class="header-anchor" href="#ro-内存同步架构" aria-hidden="true">#</a> RO 内存同步架构</h2><p>LogIndex 中保存了数据页与修改该数据页的所有 LSN 的映射关系，基于 LogIndex 可快速获取到修改某个数据页的所有 LSN，从而可将该数据页对应日志的回放操作延迟到真正访问该数据页的时刻进行。LogIndex 机制下 RO 内存同步的架构如下图所示。</p><p><img src="/PolarDB-for-PostgreSQL/assets/52_LogIndex_4.50a08309.png" alt="image.png"></p><p>RW / RO 的相关流程相较传统 share nothing 架构下有如下区别：</p><ul><li>读写节点 RW 与只读节点 RO 之间不再传输完整的 WAL 日志，仅传输 WAL meta，减少网络数据传输量，降低了 RO 与 RW 节点的延迟；</li><li>读写节点 RW 依据 WAL meta 生成 LogIndex 写入 LogIndex Memory Table 中，LogIndex Memory Table 写满之后落盘，保存至共享存储的 LogIndex Table 中，已落盘的 LogIndex Memory Table 可以被复用；</li><li>读写节点 RW 通过 LogIndex Meta 文件保证 LogIndex Memory Table I/O 操作的原子性，LogIndex Memory Table 落盘后会更新 LogIndex Meta 文件，落盘的同时还会生成 Bloom Data，通过 Bloom Data 可快速检索特定 Page 是否存在于某 LogIndex Table 中，从而忽略不必扫描的 LogIndex Table 提升效率；</li><li>只读节点 RO 接收 RW 所发送的 WAL Meta，并基于 WAL Meta 在内存中生成相应的 LogIndex，同样写入其内存的 LogIndex Memory Table 中，同时将 WAL Meta 对应已存在于 Buffer Pool 中的页面标记为 Outdate，该阶段 RO 节点并不进行真正的日志回放，无数据 I/O 操作，可去除 cache miss 的成本；</li><li>只读节点 RO 基于 WAL Meta 生成 LogIndex 后即可推进回放位点，日志回放操作被交由背景进程及真正访问该页面的 backend 进程执行，由此 RO 节点也可实现日志的并行回放；</li><li>只读节点 RO 生成的 LogIndex Memory Table 不会落盘，其基于 LogIndex Meta 文件判断已满的 LogIndex Memory Table 是否在 RW 节点已落盘，已落盘的 LogIndex Memory Table 可被复用，当 RW 节点判断存储上的 LogIndex Table 不再使用时可将相应的 LogIndex Table Truncate。</li></ul><p>PolarDB 通过仅传输 WAL Meta 降低 RW 与 RO 之间的延迟，通过 LogIndex 实现 WAL 日志的延迟回放 + 并行回放以加速 RO 的回放速度，以下则对这两点进行详细介绍。</p><h2 id="wal-meta" tabindex="-1"><a class="header-anchor" href="#wal-meta" aria-hidden="true">#</a> WAL Meta</h2><p>WAL 日志又称为 XLOG Record，如下图，每个 XLOG Record 由两部分组成：</p><ul><li>通用的首部部分 general header portion：该部分即为 XLogRecord 结构体，固定长度。主要用于存放该条 XLOG Record 的通用信息，如 XLOG Record 的长度、生成该条 XLOG Record 的事务 ID、该条 XLOG Record 对应的资源管理器类型等;</li><li>数据部分 data portion：该部分又可以划分为首部和数据两个部分，其中首部部分 header part 包含 0 ～ N 个 XLogRecordBlockHeader 结构体及 0 ～ 1 个 XLogRecordDataHeader[Short|Long] 结构体。数据部分 data part 则包含 block data 及 main data。每一个 XLogRecordBlockHeader 对应数据部分的一个 Block data，XLogRecordDataHeader[Short|Long] 则与数据部分的 main data 对应。</li></ul><p><img src="/PolarDB-for-PostgreSQL/assets/53_LogIndex_5.3a25393f.png" alt="wal meta.png"></p><p>共享存储模式下，读写节点 RW 与只读节点 RO 之间无需传输完整的 WAL 日志，仅传输 WAL Meta 数据，WAL Meta 即为上图中的 general header portion + header part + main data，RO 节点可基于 WAL Meta 从共享存储上读取完整的 WAL 日志内容。该机制下，RW 与 RO 之间传输 WAL Meta 的流程如下：</p><p><img src="/PolarDB-for-PostgreSQL/assets/54_LogIndex_6.ea27fcdf.png" alt="wal meta传输.png"></p><ol><li>当 RW 节点中的事务对其数据进行修改时，会生成对应的 WAL 日志并将其写入 WAL Buffer，同时拷贝对应的 WAL meta 数据至内存中的 WAL Meta queue 中；</li><li>同步流复制模式下，事务提交时会先将 WAL Buffer 中对应的 WAL 日志 flush 到磁盘，此后会唤醒 WalSender 进程；</li><li>WalSender 进程发现有新的日志可以发送，则从 WAL Meta queue 中读取对应的 WAL Meta，通过已建立的流复制连接发送到对端的 RO；</li><li>RO 的 WalReceiver 进程接收到新的日志数据之后，将其 push 到内存的 WAL Meta queue 中，同时通知 Startup 进程有新的日志到达；</li><li>Startup 从 WAL Meta queue 中读取对应的 meta 数据，解析生成对应的 LogIndex memtable 即可。</li></ol><p>RW 与 RO 节点的流复制不传输具体的 payload 数据，减少了网络数据传输量；此外，RW 节点的 WalSender 进程从内存中的 WAL Meta queue 中获取 WAL Meta 信息，RO 节点的 WalReceiver 进程接收到 WAL Meta 后也同样将其保存至内存的 WAL Meta queue 中，相较于传统主备模式减少了日志发送及接收的磁盘 I/O 过程，从而提升传输速度，降低 RW 与 RO 之间的延迟。</p><h2 id="logindex-1" tabindex="-1"><a class="header-anchor" href="#logindex-1" aria-hidden="true">#</a> LogIndex</h2><h3 id="内存数据结构" tabindex="-1"><a class="header-anchor" href="#内存数据结构" aria-hidden="true">#</a> 内存数据结构</h3><p>LogIndex 实质为一个 HashTable 结构，其 key 为 PageTag，可标识一个具体数据页，其 value 即为修改该 page 的所有 LSN。LogIndex 的内存数据结构如下图所示，除了 Memtable ID、Memtable 保存的最大 LSN、最小 LSN 等信息，LogIndex Memtable 中还包含了三个数组，分别为：</p><ul><li>HashTable：HashTable 数组记录了某个 Page 与修改该 Page 的 LSN List 的映射关系，HashTable 数组的每一个成员指向 Segment 数组中一个具体的 LogIndex Item；</li><li>Segment：Segment 数组中的每个成员为一个 LogIndex Item，LogIndex Item 有两种结构，即下图中的 Item Head 和 Item Seg，Item Head 为某个 Page 对应的 LSN 链表的头部，Item Seg 则为该 LSN 链表的后续节点。Item Head 中的 Page TAG 用于记录单个 Page 的元信息，其 Next Seg 和 Tail Seg 则分别指向后续节点和尾节点，Item Seg 存储着指向上一节点 Prev Seg 和后续节点 Next Seg 的指针。Item Head 和 Item Seg 中保存的 Suffix LSN 与 LogIndex Memtable 中保存的 Prefix LSN 可构成一个完整的 LSN，避免了重复存储 Prefix LSN 带来的空间浪费。当不同 Page TAG 计算到 HashTable 的同一位置时，通过 Item Head 中的 Next Item 指向下一个具有相同 hash 值的 Page，以此解决哈希冲突；</li><li>Index Order：Index Order 数组记录了 LogIndex 添加到 LogIndex Memtable 的顺序，该数组中的每个成员占据 2 个字节。每个成员的后 12bit 对应 Segment 数组的一个下标，指向一个具体的 LogIndex Item，前 4bit 则对应 LogIndex Item 中 Suffix LSN 数组的一个下标，指向一个具体的 Suffix LSN，通过 Index Order 可方便地获取插入到该 LogIndex Memtable 的所有 LSN 及某个 LSN 与其对应修改的全部 Page 的映射关系。</li></ul><p><img src="/PolarDB-for-PostgreSQL/assets/55_LogIndex_7.a84ed0dd.png" alt="logindex.png"></p><p>内存中保存的 LogIndex Memtable 又可分为 Active LogIndex Memtable 和 Inactive LogIndex Memtable。如下图所示，基于 WAL Meta 数据生成的 LogIndex 记录会写入 Active LogIndex Memtable，Active LogIndex Memtable 写满后会转为 Inactive LogIndex Memtable，并重新申请一个新的 Active LogIndex Memtable，Inactive LogIndex Memtable 可直接落盘，落盘后的 Inactive LogIndex Memtable 可再次转为 Active LogIndex Memtable。</p><p><img src="/PolarDB-for-PostgreSQL/assets/56_LogIndex_8.3f14f302.png" alt="image.png"></p><h3 id="磁盘数据结构" tabindex="-1"><a class="header-anchor" href="#磁盘数据结构" aria-hidden="true">#</a> 磁盘数据结构</h3><p>磁盘上保存了若干个 LogIndex Table，LogIndex Table 与 LogIndex Memtable 结构类似，一个 LogIndex Table 可包含 64 个 LogIndex Memtable，Inactive LogIndex Memtable 落盘的同时会生成其对应的 Bloom Filter。如下图所示，单个 Bloom Filter 的大小为 4096 字节，Bloom Filter 记录了该 Inactive LogIndex Memtable 的相关信息，如保存的最小 LSN、最大 LSN、该 Memtable 中所有 Page 在 bloom filter bit array 中的映射值等。通过 Bloom Filter 可快速判断某个 Page 是否存在于对应的 LogIndex Table 中，从而可忽略无需扫描的 LogIndex Table 以加速检索。</p><p><img src="/PolarDB-for-PostgreSQL/assets/57_LogIndex_9.1fcc55d8.png" alt="image.png"></p><p>当 Inactive LogIndex MemTable 成功落盘后，LogIndex Meta 文件也被更新，该文件可保证 LogIndex Memtable 文件 I/O 操作的原子性。如下，LogIndex Meta 文件保存了当前磁盘上最小 LogIndex Table 及最大 LogIndex Memtable 的相关信息，其 Start LSN 记录了当前已落盘的所有 LogIndex MemTable 中最大的 LSN。若 Flush LogIndex MemTable 时发生部分写，系统会从 LogIndex Meta 记录的 Start LSN 开始解析日志，如此部分写舍弃的 LogIndex 记录也会重新生成，保证了其 I/O 操作的原子性。</p><p><img src="/PolarDB-for-PostgreSQL/assets/58_LogIndex_10.2eab9094.png" alt="image.png"></p><p>由 <a href="/PolarDB-for-PostgreSQL/zh/architecture/buffer-management.html" class="">Buffer 管理</a> 可知，一致性位点之前的所有 WAL 日志修改的数据页均已持久化到共享存储中，RO 节点无需回放该位点之前的 WAL 日志，故 LogIndex Table 中小于一致性位点的 LSN 均可清除。RW 据此 Truncate 掉存储上不再使用的 LogIndex Table，在加速 RO 回放效率的同时还可减少 LogIndex Table 占用的空间。</p><h2 id="日志回放" tabindex="-1"><a class="header-anchor" href="#日志回放" aria-hidden="true">#</a> 日志回放</h2><h3 id="延迟回放" tabindex="-1"><a class="header-anchor" href="#延迟回放" aria-hidden="true">#</a> 延迟回放</h3><p>LogIndex 机制下，RO 节点的 Startup 进程基于接收到的 WAL Meta 生成 LogIndex，同时将该 WAL Meta 对应的已存在于 Buffer Pool 中的页面标记为 Outdate 后即可推进回放位点，Startup 进程本身并不对日志进行回放，日志的回放操作交由背景回放进程及真正访问该页面的 Backend 进程进行，回放过程如下图所示，其中：</p><ul><li>背景回放进程按照 WAL 顺序依次进行日志回放操作，根据要回放的 LSN 检索 LogIndex Memtable 及 LogIndex Table，获取该 LSN 修改的 Page List，若某个 Page 存在于 Buffer Pool 中则对其进行回放，否则直接跳过。背景回放进程按照 LSN 的顺序逐步推进 Buffer Pool 中的页面位点，避免单个 Page 需要回放的 LSN 数量堆积太多；</li><li>Backend 进程则仅对其实际需要访问的 Page 进行回放，当 Backend 进程需要访问一个 Page 时，如果该 Page 在 Buffer Pool 中不存在，则将该 Page 读到 Buffer Pool 后进行回放；如果该 Page 已经在 Buffer Pool 中且标记为 outdate，则将该 Page 回放到最新。Backend 进程依据 Page TAG 对 LogIndex Memtable 及 LogIndex Table 进行检索，按序生成与该 Page 相关的 LSN List，基于 LSN List 从共享存储中读取完整的 WAL 日志来对该 Page 进行回放。</li></ul><p><img src="/PolarDB-for-PostgreSQL/assets/59_LogIndex_11.e0277c33.png" alt="image.png"></p><p>为降低回放时读取磁盘 WAL 日志带来的性能损耗，同时添加了 XLOG Buffer 用于缓存读取的 WAL 日志。如下图所示，原始方式下直接从磁盘上的 WAL Segment File 中读取 WAL 日志，添加 XLog Page Buffer 后，会先从 XLog Buffer 中读取，若所需 WAL 日志不在 XLog Buffer 中，则从磁盘上读取对应的 WAL Page 到 Buffer 中，然后再将其拷贝至 XLogReaderState 的 readBuf 中；若已在 Buffer 中，则直接将其拷贝至 XLogReaderState 的 readBuf 中，以此减少回放 WAL 日志时的 I/O 次数，从而进一步加速日志回放的速度。</p><p><img src="/PolarDB-for-PostgreSQL/assets/60_LogIndex_12.6b577085.png" alt="image.png"></p><h3 id="mini-transaction" tabindex="-1"><a class="header-anchor" href="#mini-transaction" aria-hidden="true">#</a> Mini Transaction</h3><p>与传统 share nothing 架构下的日志回放不同，LogIndex 机制下，Startup 进程解析 WAL Meta 生成 LogIndex 与 Backend 进程基于 LogIndex 对 Page 进行回放的操作是并行的，且各个 Backend 进程仅对其需要访问的 Page 进行回放。由于一条 XLog Record 可能会对多个 Page 进行修改，以索引分裂为例，其涉及对 Page_0、Page_1 的修改，且其对 Page_0 及 Page_1 的修改为一个原子操作，即修改要么全部可见，要么全部不可见。针对此，设计了 mini transaction 锁机制以保证 Backend 进程回放过程中内存数据结构的一致性。</p><p>如下图所示，无 mini transaction lock 时，Startup 进程对 WAL Meta 进行解析并按序将当前 LSN 插入到各个 Page 对应的 LSN List 中。若 Startup 进程完成对 Page_0 LSN List 的更新，但尚未完成对 Page_1 LSN List 的更新时，Backend_0 和 Backend_1 分别对 Page_0 及 Page_1 进行访问，Backend_0 和 Backend_1 分别基于 Page 对应的 LSN List 进行回放操作，Page_0 被回放至 LSN_N + 1 处，Page_1 被回放至 LSN_N 处，可见此时 Buffer Pool 中两个 Page 对应的版本并不一致，从而导致相应内存数据结构的不一致。</p><p><img src="/PolarDB-for-PostgreSQL/assets/61_LogIndex_13.4a2d72a8.png" alt="image.png"></p><p>Mini transaction 锁机制下，对 Page_0 及 Page_1 LSN List 的更新被视为一个 mini transaction。Startup 进程更新 Page 对应的 LSN List 时，需先获取该 Page 的 mini transaction lock，如下先获取 Page_0 对应的 mtr lock，获取 Page mtr lock 的顺序与回放时的顺序保持一致，更新完 Page_0 及 Page_1 LSN List 后再释放 Page_0 对应的 mtr lock。Backend 进程基于 LogIndex 对特定 Page 进行回放时，若该 Page 对应在 Startup 进程仍处于一个 mini transaction 中，则同样需先获取该 Page 对应的 mtr lock 后再进行回放操作。故若 Startup 进程完成对 Page_0 LSN List 的更新，但尚未完成对 Page_1 LSN List 的更新时，Backend_0 和 Backend_1 分别对 Page_0 及 Page_1 进行访问，此时 Backend_0 需等待 LSN List 更新完毕并释放 Page_0 mtr lock 之后才可进行回放操作，而释放 Page_0 mtr lock 时 Page_1 的 LSN List 已完成更新，从而实现了内存数据结构的原子修改。</p><p><img src="/PolarDB-for-PostgreSQL/assets/62_LogIndex_14.c90cc6e7.png" alt="mini trans.png"></p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>PolarDB 基于 RW 节点与 RO 节点共享存储这一特性，设计了 LogIndex 机制来加速 RO 节点的内存同步，降低 RO 节点与 RW 节点之间的延迟，确保了 RO 节点的一致性与可用性。本文对 LogIndex 的设计背景、基于 LogIndex 的 RO 内存同步架构及具体细节进行了分析。除了实现 RO 节点的内存同步，基于 LogIndex 机制还可实现 RO 节点的 Online Promote，可加速 RW 节点异常崩溃时，RO 节点提升为 RW 节点的速度，从而构建计算节点的高可用，实现服务的快速恢复。</p></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/ApsaraDB/PolarDB-for-PostgreSQL/edit/main/zh/architecture/logindex.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页"><!--[--><!--]--> 在 GitHub 上编辑此页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: zunbao.fengzb@alibaba-inc.com">北侠</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: 562655624@qq.com">棠羽</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/PolarDB-for-PostgreSQL/zh/architecture/ddl-synchronization.html" class="" aria-label="DDL 同步"><!--[--><!--]--> DDL 同步 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/PolarDB-for-PostgreSQL/assets/app.9228397b.js" defer></script>
  </body>
</html>
